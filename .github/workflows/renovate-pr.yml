name: Renovate PR Check

on:
  workflow_call: {}

jobs:
  renovate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Enable Corepack
        run: corepack enable && corepack install

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Renovate
        id: renovate
        run: |
          export LOG_LEVEL=debug
          nvm install "$(cat .nvmrc)"
          nvm exec "$(cat .nvmrc)" npx --yes --package renovate -- \
            renovate --dry-run --token "${{ secrets.GITHUB_TOKEN }}" --platform=local > renovate-output.txt 2>&1 || true
          echo "renovate_output<<EOF" >> $GITHUB_OUTPUT
          cat renovate-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: renovate-pr-comment
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## �� Renovate Analysis

            <details>
            <summary>Click to expand Renovate output</summary>

            ```bash
            ${{ steps.renovate.outputs.renovate_output }}
            ```

            </details>

            ---
            *This comment was automatically generated by the Renovate PR workflow.*
